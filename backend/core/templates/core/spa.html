{% load vite %}

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script>
      (function() {
        var theme = 'system';
        try { theme = localStorage.getItem('hyperclast-theme') || 'system'; } catch(e) {}
        var effective = theme === 'system'
        ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')
        : theme;
        document.documentElement.setAttribute('data-theme', effective);
        document.documentElement.classList.add(effective);
      })();
    </script>
    <title>{{ brand_name }}</title>
    {% include 'core/partials/_favicon.html' %}

    {% vite_css "src/app.js" %}
  </head>
  <body>
    <div id="app"></div>

    <!-- Toolbar container - mounted by Svelte -->
    <div id="toolbar-wrapper" style="display: none;"></div>

    {% if request.user.is_authenticated %}
      {{ request.user.email|json_script:"user-email" }}
      {{ request.user.external_id|json_script:"user-external-id" }}
      {{ request.user.username|json_script:"user-username" }}
    {% endif %}
    {{ feature_flags|json_script:"feature-flags" }}
    {{ previewable_image_types|json_script:"previewable-image-types" }}
    {% csrf_token %}

    <script>
      const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
      window._csrfToken = csrfInput ? csrfInput.value : '';

      const userEmailEl = document.getElementById('user-email');
      if (userEmailEl) {
        window._userIsAuthenticated = true;
        window._userInfo = {
          email: JSON.parse(userEmailEl.textContent),
        };
        const userExternalIdEl = document.getElementById('user-external-id');
        if (userExternalIdEl && userExternalIdEl.textContent !== 'null') {
          window._userInfo.externalId = JSON.parse(userExternalIdEl.textContent);
        }
        const userUsernameEl = document.getElementById('user-username');
        if (userUsernameEl && userUsernameEl.textContent !== 'null') {
          window._userInfo.username = JSON.parse(userUsernameEl.textContent);
        }
      } else {
        window._userIsAuthenticated = false;
        window._userInfo = null;
      }

      const featureFlagsEl = document.getElementById('feature-flags');
      window._featureFlags = featureFlagsEl ? JSON.parse(featureFlagsEl.textContent) : {};

      // Previewable image types - set from backend (see filehub/schemas.py:get_previewable_image_types)
      const previewableImageTypesEl = document.getElementById('previewable-image-types');
      window._previewableImageTypes = previewableImageTypesEl ? JSON.parse(previewableImageTypesEl.textContent) : [];

      // Demo mode flag (set by /demo/ route)
      window._isDemoMode = {{ is_demo_mode|yesno:"true,false" }};
    </script>

    <script type="module" crossorigin src="{% vite_asset 'src/app.js' %}"></script>
  </body>
</html>
