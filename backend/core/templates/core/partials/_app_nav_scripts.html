{% if user.is_authenticated %}
  <script>
    (function() {
      var userAvatar = document.getElementById("user-avatar");
      var userDropdown = document.getElementById("user-dropdown");
      var userInitial = document.getElementById("user-initial");
      var userGravatar = document.getElementById("user-gravatar");

      if (userGravatar) {
        if (userGravatar.complete && userGravatar.naturalHeight > 0) {
          userInitial.style.display = "none";
          userGravatar.style.display = "block";
        } else {
          userGravatar.onload = function() {
            userInitial.style.display = "none";
            userGravatar.style.display = "block";
          };
          userGravatar.onerror = function() {
            userGravatar.style.display = "none";
            userInitial.style.display = "block";
          };
        }
      }

      if (userAvatar && userDropdown) {
        userAvatar.addEventListener("click", function(e) {
          e.stopPropagation();
          userDropdown.classList.toggle("open");
        });

        document.addEventListener("click", function(e) {
          if (!userDropdown.contains(e.target) && !userAvatar.contains(e.target)) {
            userDropdown.classList.remove("open");
          }
        });
      }

      var logoutBtn = document.getElementById("logout-btn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", function() {
          var csrfToken = "";
          var csrfCookie = document.cookie.split(";").find(function(c) {
            return c.trim().startsWith("csrftoken=");
          });
          if (csrfCookie) {
            csrfToken = csrfCookie.split("=")[1];
          }

          fetch("/api/browser/v1/auth/session", {
            method: "DELETE",
            credentials: "same-origin",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken
            }
          }).finally(function() {
            window.location.href = "/login/";
          });
        });
      }
    })();
  </script>
{% endif %}
